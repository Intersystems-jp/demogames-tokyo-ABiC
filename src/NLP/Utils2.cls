Class NLP.Utils2
{

/// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒ™ãƒ¼ã‚¹URL
/// Parameter baseurl = "https://ec2-52-194-192-117.ap-northeast-1.compute.amazonaws.com/csp/user/_DeepSee.UserPortal.DashboardViewer.zen?DASHBOARD=";
Parameter baseurl = "https://localhost:7443/csp/user/_DeepSee.UserPortal.DashboardViewer.zen?DASHBOARD=";

/// in : ç”ŸæˆAIã‹ã‚‰å¾—ãŸJSON
/// {
///  "cube": "ABiCAttendanceCube",
///  "measures": [
///    {
///      "name": "%COUNT",
///      "mdx": "[Measures].[%COUNT]"
///    }
///  ],
///  "dimensions": [
///    {
///      "name": "EmpRole",
///      "mdx": "[EmpRole].[H1].[EmpRole]"
///    },
///    {
///      "name": "ShiftName",
///      "mdx": "[ShiftName].[H1].[ShiftName]"
///    },
///    {
///      "name": "DateOfEx",
///      "mdx": "[DateOfEx].[H1]"
///    }
///  ],
///  "filters": {
///    "DateOfEx": { "Year": 2024, "Month": 4 },
///    "mdx_where": [
///      "[DateOfEx].[H1].[Year].&[2024]",
///      "[DateOfEx].[H1].[Month].&[4]"
///    ]
///  },
///  "group_by": [
///    { "name": "EmpRole", "mdx": "[EmpRole].[H1].[EmpRole]" },
///    { "name": "ShiftName", "mdx": "[ShiftName].[H1].[ShiftName]" }
///  ]
/// }
/// 
ClassMethod Run(input As %String(MAXLEN=""), APIKey As %String(MAXLEN="")) As %String(MAXLEN="")
{
    #dim ex As %Exception.AbstractException
    try {
        //************
        //set start=$ZH
        //************
        set ^iijima=input
        //ã©ã†ã—ã¦ã‚‚å…ˆé ­ã«JSONä»¥å¤–ã®æ–‡å­—åˆ—ã‚’ä»˜ã‘ã‚‹ã®ã§ã‚«ãƒƒãƒˆã™ã‚‹ã€
        set input=$EXTRACT(input,$FIND(input,"{")-1,*)
        set in={}.%FromJSON(input) 
        //pivotä½œæˆ
        set num=$increment(^ABiC("pivotNum"))
        set pivotname="ABiCPivot"_num
        set ^ABiC("pivotName",num)=pivotname_"^"_in.cube
        $$$ThrowOnError(..createPivot(.in,pivotname))
        
        //filterä½œæˆ
        if $ISOBJECT(in.%Get("filters")) && ($ISOBJECT(in.%Get("filters")."mdx_where")) {
            set iter=in.filters."mdx_where".%GetIterator()
            while iter.%GetNext(.key,.val) {
                if val["Year" {
                    set yearfilt=$piece(val,".",$length(val,"."))
                }
                else {
                    set monthfilt=$piece(val,".",$length(val,"."))
                }
            }
            set mdxwhere=in.filters."mdx_where"
        }
        //Dashboardä½œæˆæº–å‚™
        if '$data(^ABiC("dashName")) { 
            set num=$increment(^ABiC("DashNum"))
            set dashname="ABiCDash"_num
            set ^ABiC("dashName",num)=dashname
        }
        else {
            set dashname=^ABiC("dashName",$Get(^ABiC("DashNum")))
        }
        //ä½œæˆæ¸ˆpivotãŒã‚ã£ãŸã‚‰ãã‚Œã‚’è¿½åŠ ã™ã‚‹
        set exnum=""
        for {
            set exnum=$order(^ABiC("pivotName",exnum),1,expivot)
            if exnum="" quit
            set p($PIECE(expivot,"^",1))=$PIECE(expivot,"^",2)
        }
        //ä»Šå›ä½œæˆã—ãŸãƒ”ãƒœãƒƒãƒˆã‚’è¿½åŠ 
        // p(pivotname)=cubeå
        set p(pivotname)=in.cube
        
        /*KPIè¿½åŠ ã‚’ã‚„ã‚ã‚‹*/
        //if $get(^ABiC("pivotNum"))=2 {
            // KPIè¿½åŠ ã™ã‚‹
            //set p("kpipivot")="SQLBaseKPI.kpi"
            /*
            set num=$increment(^ABiC("pivotNum"))
            set ^ABiC("pivotName",num)="SQLBaseKPI.kpi"
            */
        //}
        
        //************
        //zw p,dim,measure,d,monthfilt,yearfilt
        //************
        if $get(yearfilt)'="" || ($get(monthfilt)'="") {
            set DateOfEx=1
        }
        else {
            set DateOfEx=0
        }
        $$$ThrowOnError(..createDashboard(.p,dashname,DateOfEx,1,$get(yearfilt),$get(monthfilt),1))
        set url=..#baseurl_dashname_".dashboard&NOTITLE=1"
        set ^iijima("url")=url
        set j={}
        set j.url=url

        //ä½œæˆã§ããŸãƒ”ãƒœãƒƒãƒˆã‹ã‚‰MDXå¼ã¨çµæœã‚’JSONã«å‡ºã—ã€ã‚µãƒãƒªã¨ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ã‚’OpenAIã«èã
        set mdxwhere=in.filters."mdx_where"
        $$$ThrowOnError(..getRecommend(APIKey,pivotname,mdxwhere,.openairesponse))
        if $ISOBJECT(openairesponse) {
            // å®Ÿè¡Œæ™‚ã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’ã‚ªãƒ¼ãƒãƒ¼ã™ã‚‹ã¨messageç›´ä¸‹ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¥ã‚‹
            if $ISOBJECT(openairesponse.choices) {
                set j.recommend=openairesponse.choices.%Get(0).message.content
            }
            else {
                set j.recommend="OpenAI ERROR: "_openairesponse.error.message
            }
        }
        //************
        //set end=$ZH
        //write "å®Ÿè¡Œæ™‚é–“ï¼š",end-start,!
        //************

        set returnJson=j.%ToJSON()
        /*
        set j.explain="ğŸ’¡ After changing to pivot window, select a cell and click on the binoculars button to see the original data of the analysis results."
        set:$data(p("kpipivot")) j.recommend="ğŸ‘ Do you need to check your inventory data? I put the pivot in your dashboard."
        //set returnjson=j.%ToJSON()
        // Adaptive Cardä½œæˆ
        set facts1=##class(NLP.CardFacts).%New()
        set card=##class(NLP.Card).%New()
        set facts1.Key="How to use it: "
        set facts1.Value=j.explain
        do card.Facts.Insert(facts1)
        if j.recommend'="" {
            set facts2=##class(NLP.CardFacts).%New()
            set facts2.Key="Recommend: "
            set facts2.Value=j.recommend
            do card.Facts.Insert(facts2)
        } 
        set card.createDate=$ZDATE(+$H)
        set card.URL=url
        $$$ThrowOnError(card.OutputToDynamicObject(.returnJson))

        return returnJson.%ToJSON()
        */
    }
    catch ex {
        set j={}
        set j.Error="Error:"_ex.DisplayString()
        set returnJson=j.%ToJSON()
    }
    set ^iijima("ret")=returnJson
    return returnJson
}

/// /src/wsgi/config.pyã«è¨˜è¼‰ã—ã¦ã„ã‚‹ã‚µãƒãƒªã¨ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰å–å¾—ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå–å¾—
ClassMethod getSystemPrompt() As %String(MAXLEN="")
{
    set sys=##class(%SYS.Python).Import("sys")
    do sys.path.append("/src/wsgi")
    set config=##class(%SYS.Python).Import("config")
    return config.forSummary
}

/// ä½œæˆã§ããŸãƒ”ãƒœãƒƒãƒˆã‹ã‚‰MDXå¼ã¨çµæœã‚’JSONã§å…¥æ‰‹ã—ã€OpenAIã«å•ã„åˆã‚ã›ã‚‹
/// ç¬¬1å¼•æ•°ï¼šãƒ”ãƒœãƒƒãƒˆå
/// ç¬¬2å¼•æ•°ï¼šfilterãŒã‚ã‚Œã°ã€mdx_whereã®JSONé…åˆ—ï¼ˆãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
/// ç¬¬3å¼•æ•°ï¼šOpenAIã‹ã‚‰ã®HTTPå¿œç­”
ClassMethod getRecommend(APIKey As %String(MAXLEN=""), pivot As %String, ByRef mdxwhere As %DynamicArray, ByRef response As %DynamicArray) As %Status
{
    #dim ex As %Exception.AbstractException
    set status=$$$OK
    try {
        if $get(pivot)="" {
            throw ##class(%Exception.General).%New("ABiC-PivotError",5001,,"PivotãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        }
        // IRISã«POSTè¦æ±‚å®Ÿè¡Œï¼šPivotã®MDXå¼ã¨çµæœã‚’å–å¾—ã™ã‚‹
        set server="abicWG"
        set port=80
        set location="/api/deepsee/v3/user/Data/PivotExecute"
        set body={}
        set body.PIVOT=pivot
        if $ISOBJECT(mdxwhere) {
            set body.FILTERS=mdxwhere
        }
        $$$ThrowOnError(..POSTRequest(server,location,port,,.body,.response))
        set ^iijima("get-recommend-iris-mdx-result")=response.%ToJSON()

        //OpenAIã¸ã®é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æº–å‚™
        set sendjson={}
        set sendjson.model="gpt-4o"
        set sendjson.messages=[]
        set prompt={}
        set prompt.role="system"
        set prompt.content=##class(NLP.Utils2).getSystemPrompt()
        do sendjson.messages.%Push(prompt)
        set prompt={}
        set prompt.role="user"
        set prompt.content=response.%ToJSON()
        do sendjson.messages.%Push(prompt)
        //OpenAIã«çµæœã®ã‚µãƒãƒªã¨æ¬¡ã®åˆ†ææ–‡ã‚’ä½œã£ã¦ã‚‚ã‚‰ã†
        // IRISã«POSTè¦æ±‚å®Ÿè¡Œï¼šPivotã®MDXå¼ã¨çµæœã‚’å–å¾—ã™ã‚‹
        set server="api.openai.com"
        set port=443
        set location="/v1/chat/completions"
        set key=APIKey
        $$$ThrowOnError(..POSTRequest(server,location,port,key,.sendjson,.response))
        set ^iijima("get-recommend-openai")=response.%ToJSON()
    }
    catch ex {
        set status=ex.AsStatus()
        set ^iijima("get-recommend-err")=ex.DisplayString()
    }
    return status
}

ClassMethod POSTRequest(server As %String, location As %String, port As %Integer, key As %String(MAXLEN=1000), ByRef body As %DynamicArray, ByRef response As %DynamicArray) As %Status
{
    #dim ex As %Exception.AbstractException
    set status=$$$OK
    try {
        set req=##class(%Net.HttpRequest).%New()
        set req.Server=server
        if server="abicWG" {
            set base64=$SYSTEM.Encryption.Base64Encode("_system:SYS")
            do req.SetHeader("Authorization","Basic "_base64)
        }
        if $Get(key)'="" {
            //OpenAIã‚’æƒ³å®š
            do req.SetHeader("Authorization","Bearer "_key)
        }
        set req.Location=location
        if port'=80 {
            set req.SSLConfiguration="webapi"
            set req.Https=1
        }
        set req.ContentType="application/json"
        set req.ContentCharset="utf-8"
        // Body
        do body.%ToJSON(req.EntityBody)
        $$$ThrowOnError(req.Post())
        set response={}.%FromJSON(req.HttpResponse.Data)
    }
    catch ex {
        set status=ex.AsStatus()
        set ^iijima("get-recommend-err")=ex.DisplayString()
    }
    return status
}

/// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä½œæˆ
/// ãƒ”ãƒœãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºã¨ã™ã‚‹ã€‚DateOfExãŒã‚ã‚‹å ´åˆã¯ãƒ•ã‚£ãƒ«ã‚¿ã«Yearã¨Monthã‚’ç½®ãã‚ˆã†ã«ã™ã‚‹
/// pivots ãƒ”ãƒœãƒƒãƒˆåã‚’ç¬¬1ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å…¥ã‚Œã¦æ¸¡ã™
///     pivots("t1")=""
///     pivots("t2")=""
/// dash ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å
/// åŒåã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ã—ã¦ã‹ã‚‰ä½œæˆã™ã‚‹
/// Yearã®ãƒ•ã‚£ãƒ«ã‚¿ã®å€¤ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã—ãŸï¼š&[2024]
/// Monthã®ãƒ•ã‚£ãƒ«ã‚¿ã®å€¤ã‚’æŒ‡å®šï¼š&[12] ãªã©
ClassMethod createDashboard(ByRef pivots As %String, dash As %String, DateOfEx As %Boolean = 0, Dept As %Boolean = 0, YearFilt As %String = "", MonthFilt As %String = "", Listing As %Boolean = 0) As %Status
{
    set status=$$$OK
    try {
        if ##class(%DeepSee.Dashboard.Utils).%DashboardExists(dash_".dashboard")'=0 {
            set flg=##class(%DeepSee.Dashboard.Utils).%DeleteDashboard(dash_".dashboard")
            if flg=0 {
                throw ##class(%Exception.General).%New("Dashboradå‰Šé™¤ã‚¨ãƒ©ãƒ¼",5001,,dash_"ã‚’å‰Šé™¤ã§ãã¾ã›ã‚“ã§ã—ãŸ")
            }
        }
        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä½œæˆ
        set d=##class(%DeepSee.Dashboard.Definition).%New()
        set d.createdBy="SuperUser"
        set d.name=dash
        /* snapGridã¨snapToãªã„ã¨è¡¨ç¤ºã•ã‚Œãªã„*/
        set d.snapGrid=1
        set d.snapTo=1
        set d.worklistCount=1
        //widgetsç™»éŒ²
        set pname="",num=1,(homeR,homeC)=0,colS=5,rowS=4
        for {
            set pname=$ORDER(pivots(pname),1,cubename)
            if pname="" quit
            set w=##class(%DeepSee.Dashboard.Widget).%New()
            set w.name=pname
            set w.type="pivot"
            set w.subtype="pivot"
            set w.title=pname
            set w.subtypeClass="lineChart"
            set w.width=300
            set w.height=200
            // ä½•å€‹ç›®ã‹ã®ãƒ”ãƒœãƒƒãƒˆã§å ´æ‰€ã‚’å¤‰æ›´
            if num>1 {
                //2ã§å‰²ã£ã¦ä½™ã‚Š1ã®æ™‚                 
                if num#2 {
                    set homeR=homeR+rowS
                    set homeC=0
                    set colS=5
                }
                else {
                    set homeR=homeR
                    set rowS=4
                    set homeC=homeC+colS
                }
            }
            set w.homeRowL=homeR
            set w.homeColL=homeC
            set w.colSpanL=colS
            set w.rowSpanL=rowS
            if cubename[".kpi" {
                set w.dataSource=cubename
                set w.name="StockInfo"  //æ¸¡ã£ã¦ãã‚‹ã®ã¯"kpipivot"ãªã®ã§KPIã¯StockInfoã¨ã™ã‚‹
                // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã«ãƒ•ã‚£ãƒ«ã‚¿ã‚’ä»˜ã‘ã‚‹
                set c1=##class(%DeepSee.Dashboard.Control).%New()
                set c1.action="applyFilter"
                set c1.label="Year"
                set c1.location="widget"
                set c1.targetProperty="Year"
                do w.controls.Insert(c1)
                set c2=##class(%DeepSee.Dashboard.Control).%New()
                set c2.action="applyFilter"
                set c2.label="Month"
                set c2.location="widget"
                set c2.targetProperty="Month"
                do w.controls.Insert(c2)
                set c3=##class(%DeepSee.Dashboard.Control).%New()
                set c3.action="ShowAreaInfo"
                set c3.label="ShowAreaInfo"
                set c3.location="widget"
                set c3.type="auto"
                do w.controls.Insert(c3)
            }
            else {
                set w.dataSource=pname_".pivot"
            }
            //controlsç™»éŒ²
            //æ—¢ã«ã‚ã‚Œã°ä»˜ã‘ãªã„
            //if (num=1)&&(DateOfEx=1) {
            if DateOfEx=1&&($get(DateOfExExisting)="") {
                set c1=##class(%DeepSee.Dashboard.Control).%New()
                set c2=##class(%DeepSee.Dashboard.Control).%New()
                set c1.action="applyFilter"
                set c2.action="applyFilter"
                set c1.targetProperty="[DateOfEx].[H1].[Year]"
                set c1.label="Year"
                set c2.targetProperty="[DateOfEx].[H1].[Month]"
                set c2.label="Month"
                set c1.location="dashboard"
                set c2.location="dashboard"
                set c1.target="*"
                set c2.target="*"
                set c1.value=YearFilt
                set c2.value=MonthFilt
                do w.controls.Insert(c1)
                do w.controls.Insert(c2)
                set DateOfExExisting=1
            }
            //if (num=1)&&(Dept=1) {
            if Dept=1 &&($get(DeptExisting)=""){
                set c3=##class(%DeepSee.Dashboard.Control).%New()
                set c3.action="applyFilter"
                set c3.targetProperty="[Department].[H1].[Department]"
                set c3.label="Department"
                set c3.location="dashboard"
                set c3.target="*"
                do w.controls.Insert(c3)
                set DeptExisting=1
            }
            // è©³ç´°ãƒªã‚¹ãƒˆã‚’ä»˜ã‘ã‚‹å ´åˆ
            //Cubeåã‹ã‚‰è©³ç´°ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã€ã‚ã‚‹åˆ†ã ã‘ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¨ã—ã¦è¨­å®š
            if (Listing=1)&&(cubename'[".kpi") {
                $$$ThrowOnError(##class(%DeepSee.Utils).%GetCubeListings(cubename,.listing))
                set lcn=""
                for {
                    set lcn=$Order(listing(lcn))
                    if lcn="" quit
                    set clisting=##class(%DeepSee.Dashboard.Control).%New()
                    set clisting.action="showListing"
                    set clisting.targetProperty=lcn
                    set clisting.label=lcn
                    set clisting.location="widget"
                    set clisting.type="auto"
                    set clisting.activeWhen="itemSelected"
                    do w.controls.Insert(clisting)
                }
            }
            kill cubename
            do d.widgets.Insert(w)
            set num=num+1
        }
        $$$ThrowOnError(d.%Save())
    }
    catch ex {
        set status=ex.AsStatus()
    }
    return status
}

/// ã€Šãƒ”ãƒœãƒƒãƒˆä½œæˆæ–¹æ³•ã€‹
/// %DeepSee.Dashboard.Pivotã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
///  cubeNameã«ã‚­ãƒ¥ãƒ¼ãƒ–åè¨­å®š
///  name ã«ãƒ”ãƒœãƒƒãƒˆåæŒ‡å®šï¼ˆæ‹¡å¼µå­ã„ã‚‰ãªã„ï¼‰ 
///  rowLevelsã«ãƒ‡ã‚£ãƒ¡ãƒ³ã‚¸ãƒ§ãƒ³ã®å†…å®¹å…¥ã£ã¦ã‚‹ï¼ˆãƒªã‚¹ãƒˆï¼‰
/// ã€€ã€€rowLevelsã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ %DeepSee.Dashboard.PivotLevel ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
///     ã€€textã€€ã«ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºå
///     ã€€spec ã«MDXå¼
///     CROSSJOINã—ã¦ã‚‹å ´åˆã¯childLevelsã‚’ä½¿ã†
///         childLevelsãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚‚ãƒªã‚¹ãƒˆã€ã‚¿ã‚¤ãƒ—ã¯%DeepSee.Dashboard.PivotLevel
///         textã«ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºå
///         specã«MDXå¼
///     do rowLevels.Insert(ä½œã£ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹)ã€€ã§è¨­å®šã™ã‚‹
///  Measureã¯Pivotã‚¯ãƒ©ã‚¹ã®measuresï¼ˆãƒªã‚¹ãƒˆï¼‰%DeepSee.Dashboard.PivotLevel
///     textã«è¡¨ç¤ºå
///     specã«MDXå¼
/// ==============================================================
/// ç¬¬ï¼‘ä½å¼•æ•°ï¼šãƒ‡ã‚£ãƒ¡ãƒ³ã‚¸ãƒ§ãƒ³
///     æ·»ãˆå­—ã«MDXï¼ˆ"row or col",[xx].Members ãªã©ï¼‰ ãƒ‡ãƒ¼ã‚¿éƒ¨ã¯è¡¨ç¤ºå
///     ç¬¬ï¼‘ãƒ¬ãƒ™ãƒ«ã®ã¿ã®å ´åˆ
///         dimentions("row","[xx].Members")="è¡¨ç¤ºå"  ->è¡ŒæŒ‡å®š
///         dimentions("col","[xxx].Members")="è¡¨ç¤ºå"  -> åˆ—æŒ‡å®š
///     å­ãƒ¬ãƒ™ãƒ«ã‚’æŒã¤å ´åˆ
///         dimentions("row","[xx].Members","[childxx].Members")="è¡¨ç¤ºå"
///     æ·»ãˆå­—ã®éšå±¤é€šã‚Šã«å­ãƒ¬ãƒ™ãƒ«ã¨ã—ã¦è¨­å®šã™ã‚‹
/// ç¬¬2å¼•æ•°ï¼šãƒ¡ã‚¸ãƒ£ãƒ¼ã®ã¿
///     measure("[xx]")="è¡¨ç¤ºå"
/// ç¬¬3å¼•æ•°ï¼šã‚­ãƒ¥ãƒ¼ãƒ–å
/// ç¬¬4å¼•æ•°ï¼šä½œæˆã™ã‚‹ãƒ”ãƒœãƒƒãƒˆåï¼ˆæ—¢å­˜åã‚ã£ã¦ã‚‚ä¿å­˜å¯èƒ½ã ã‘ã©æ—¢å­˜æ®‹ã‚‹ï¼‰
ClassMethod createPivot(in As %DynamicArray, pivotname As %String = "try9") As %Status
{
    set status=$$$OK
    try {
        //åŒã˜ãƒ”ãƒœãƒƒãƒˆåãŒå­˜åœ¨ã—ã¦ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã€å­˜åœ¨ã—ã¦ã‚Œã°å‰Šé™¤
        do ..deleteSameNamePivot(pivotname)
        set p=##class(%DeepSee.Dashboard.Pivot).%New()
        set p.createdBy="SuperUser"
        set p.name=pivotname
        set p.cubeName=in.cube

        //ãƒ‡ã‚£ãƒ¡ãƒ³ã‚¸ãƒ§ãƒ³ã®è¨­å®š
        set dimentions=in.dimensions
        do ..SetLevel(.dimentions,.p)
        
        //ãƒ¡ã‚¸ãƒ£ãƒ¼è¨­å®š
        set iter=in.measures.%GetIterator()
        //ãƒ¡ã‚¸ãƒ£ãƒ¼ãŒè¤‡æ•°ã‚ã‚‹æ™‚ã¯COUNTã‚’é™¤ã
        while iter.%GetNext(.key,.val) {
            set m=##class(%DeepSee.Dashboard.PivotLevel).%New()
            set m.text=val.name
            set m.spec=val.mdx
            if val.name="%COUNT" {
                set countari=key+1
            }
            do p.measures.Insert(m)      
        }
        if key>0 && ($get(countari)'="") {
            do p.measures.RemoveAt(countari)
        }
        $$$ThrowOnError(p.%Save())
    }
    catch ex {
        set status=ex.AsStatus()
    }
    return status
}

/// name : ãƒ”ãƒœãƒƒãƒˆåï¼ˆæ‹¡å¼µå­ãªã—ï¼‰
ClassMethod deleteSameNamePivot(name As %String) As %Status
{
    set status=$$$OK
    try {
        set sql="select ID FROM %DeepSee_Dashboard.Pivot where name=?"
        set stmt=##class(%SQL.Statement).%New()
        $$$ThrowOnError(stmt.%Prepare(sql))
        set rset=stmt.%Execute(name)
        while rset.%Next() {
            set id=rset.ID
            &sql(delete from %DeepSee_Dashboard.Pivot where ID=:id)
            if SQLCODE<0 {
                throw ##class(%Exception.SQL).CreateFromSQLCODE(SQLCODE,%msg)
            }
        }
    }
    catch ex {
        set status=ex.AsStatus()
    }
    return status
}

/// dimentionsï¼šä»¥ä¸‹ã€%DynamicArrayãŒæ¸¡ã‚‹
///   "dimensions": [
///    {
///      "name": "EmpRole",
///      "mdx": "[EmpRole].[H1].[EmpRole]"
///    },
///    {
///      "name": "ShiftName",
///      "mdx": "[ShiftName].[H1].[ShiftName]"
///    },
///    {
///      "name": "DateOfEx",
///     "mdx": "[DateOfEx].[H1]"
///    }
///  ]
/// pivotï¼šãƒ”ãƒœãƒƒãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
/// 
/// ãƒ”ãƒœãƒƒãƒˆä½œæˆæ™‚
///     ã€€textã€€ã«ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºå
///     ã€€spec ã«MDXå¼
ClassMethod SetLevel(ByRef dimentions As %String, ByRef pivot As %DeepSee.Dashboard.Pivot)
{
    set iter=dimentions.%GetIterator()

    // ãƒ‡ã‚£ãƒ¡ãƒ³ã‚¸ãƒ§ãƒ³ï¼’å€‹ç›®ãŒããŸã‚‰ï¼‘å€‹ç›®ã®å­ã«ã€‚ï¼“å€‹ç›®ä»¥é™ã¯åˆ—ã«ã™ã‚‹
    set cn=1
    while iter.%GetNext(.key,.val) {
        // %DeepSee.Dashboard.PivotLevelã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
        set level(cn)=##class(%DeepSee.Dashboard.PivotLevel).%New()
        set level(cn).spec=val.mdx
        set level(cn).text=val.name
        set cn=cn+1
        /*
        //0ç•ªç›®ã¯è¡Œã«è¿½åŠ 
        if key=0 {
            do pivot.rowLevels.Insert(level(0))
        }
        //1ç•ªç›®ã¯0ç•ªç›®ã®å­ãƒ¬ãƒ™ãƒ«ã¨ã—ã¦è¿½åŠ 
        if key=1 {
            do level(0).childLevels.Insert(level(1))
            do pivot.rowLevels.RemoveAt(1) // 1å€‹å‰ã«å…¥ã‚ŒãŸrowã®å†…å®¹ã‚’ä¸€æ—¦å‰Šé™¤
            do pivot.rowLevels.Insert(level(0))
        }
        if key>2 {
            do pivot.columnLevels.Insert(level(key))
        }
        */
    }
    // levelã®æ·»ãˆå­—ã®åˆ†ã ã‘rowã¨colã«è¨­å®š
    set k=""
    for {
        set k=$order(level(k),1,data)
        if k="" { quit }
        if k=1 {
            do pivot.rowLevels.Insert(data)
            continue
        }
        if (k=2) && (cn>=2) {
            do level(1).childLevels.Insert(data)
            continue
        }
        #;æ®‹ã‚Šã¯col
        else {
            do pivot.columnLevels.Insert(level(k))
        }
    }
}

/// ä½œæˆã—ãŸãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€ãƒ”ãƒœãƒƒãƒˆã®å‰Šé™¤
/// Delete ABiC dashboards and pivots.
ClassMethod ABiCDelete() As %Status
{
    #dim ex As %Exception.AbstractException
    set status=$$$OK
    try {
        write "ä½œæˆã—ãŸãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¨ãƒ”ãƒœãƒƒãƒˆã‚’æ¶ˆã—ã¾ã™ï¼ˆDelete ABiC dashboards and pivots.ï¼‰",!
        set cn=""
        for {
            set cn=$ORDER(^ABiC("dashName",cn),1,data)
            if cn="" quit
            set fullname=data_".dashboard"
            $$$ThrowOnError(##class(%DeepSee.UserLibrary.Utils).%DeleteFolderItem(fullname,.count))
            kill data
        }
        set cn=""
        for {
            set cn=$ORDER(^ABiC("pivotName",cn),1,data)
            if cn="" quit
            set fullname=$piece(data,"^",1)_".pivot"
            $$$ThrowOnError(##class(%DeepSee.UserLibrary.Utils).%DeleteFolderItem(fullname,.count))
            kill data
        }
        if $$$ISOK(status) {
            kill ^ABiC
        }
    }
    catch ex {
        set status=ex.AsStatus()
    }
    return status
}

/// ç¬¬1å¼•æ•°ï¼šã‚­ãƒ¥ãƒ¼ãƒ–åã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§æŒ‡å®š
///     ABiCAttendanceCube,ABiCClinicDataCube,ABiCConsecutiveDayCube,ABiCIncidentReportCube,MaterialTransaction
/// ç¬¬2å¼•æ•°ï¼šå‚ç…§æ¸¡ã—ã§ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ã‘å–ã‚‹å¤‰æ•°ã‚’æŒ‡å®š
ClassMethod GetCubeInfo(input As %Integer = "ABiCAttendanceCube,ABiCClinicDataCube,ABiCConsecutiveDayCube,ABiCIncidentReportCube,MaterialTransaction", ByRef resultjson As %String) As %Status
{
    #dim ex As %Exception.AbstractException
    set status=$$$OK
    try {
        //Measureã®å–ã‚Šå‡ºã—URL
        //https://localhost:7443/api/deepsee/v3/user/Info/Measures/MaterialTransaction

        //Dimensionã®å–ã‚Šå‡ºã—ã¯ä»¥ä¸‹ãƒ¡ã‚½ãƒƒãƒ‰
        //w ##class(%DeepSee.Utils).%GetDimensionList("MaterialTransaction",.pinfo)
        //Listingã®å–ã‚Šå‡ºã—ã¯ä»¥ä¸‹
        //https://localhost:7443/api/deepsee/v3/user/Info/Listings/MaterialTransaction
        /* json ã®ä»•æ§˜
        {
            [
                "Cube": "åç§°",
                "Measures":[
                    ãƒ¡ã‚¸ãƒ£ãƒ¼æƒ…å ±
                ],
                "Dimensions":[
                    "name":"Department",
                    "hierarchies":{
                        "name":"H1"
                        "levels":[
                            "Year",
                            "Month",
                            "Year"
                        ]
                    }
                ],
                "Listings":[
                ]
        }
        */
        set resultjson=[]
        set request=##class(%Net.HttpRequest).%New()
        set request.Server="abicWG"
        set request.Port=80
        set base64=$SYSTEM.Encryption.Base64Encode("_system:SYS")
        do request.SetHeader("Authorization","Basic "_base64)
        set baseurl="/api/deepsee/v3/user/Info/"
        for i=1:1:$length(input,",") {
            set cube=$piece(input,",",i)
            set cubejson={}
            set cubejson.Cube=cube
            set cubejson.Dimensions=[]
            // Measureså–å¾—
            set cubejson.Measures=[]
            do request.SetHeader("Authorization","Basic "_base64)
            set request.Location=baseurl_"Measures/"_cube
            $$$ThrowOnError(request.Get())
            set response=request.HttpResponse
            set rjson={}.%FromJSON(response.Data)
            //do rjson.Result.Measures.%ToJSON()
            do cubejson.Measures.%Push(rjson.Result.Measures)

            //Dimensionså–å¾—
            $$$ThrowOnError(##class(%DeepSee.Utils).%GetDimensionList(cube,.dinfo))
            set (d1,d2,d3,data)=""
            for {
                set d1=$order(dinfo(d1))
                if d1="" { quit }
                for {
                    set d2=$order(dinfo(d1,d2))
                    if d2="" {quit}
                    set dim=[]
                    for {
                        set d3=$order(dinfo(d1,d2,d3),1,data)
                        if d3="" {quit}
                        if $list(data,1)="l" {
                            set dimobj={},dimobj.List=[]
                            set dimobj.Name=$LIST(data,2)
                            set dimobj.Hierarchy=$LIST(data,3)
                            do dimobj.List.%Push($LIST(data,4))
                            do dim.%Push(dimobj)
                        }
                    }
                    if dim.%Size()>0 {
                        do cubejson.Dimensions.%Push(dim)
                    }
                }
            }
            do resultjson.%Push(cubejson)
        }
    }
    catch ex {
        write ex.DisplayString(),!
        set status=ex.AsStatus()
    }
    return status
}

}
